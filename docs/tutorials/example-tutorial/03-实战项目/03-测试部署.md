---
title: 3.3 测试部署
date: 2025-01-01
categories:
  - 示例教程
tags:
  - 测试
  - 部署
---

# 3.3 测试部署

## 编写测试

### 单元测试

```javascript
// tests/task.test.js
const Task = require('../models/Task');

describe('Task Model', () => {
    test('should create a task', async () => {
        const task = await Task.create({
            title: 'Test Task',
            description: 'Test Description'
        });
        
        expect(task.title).toBe('Test Task');
        expect(task.status).toBe('pending');
    });
    
    test('should update task status', async () => {
        const task = await Task.create({
            title: 'Test Task',
            status: 'pending'
        });
        
        await task.update({ status: 'completed' });
        expect(task.status).toBe('completed');
    });
});
```

### API 测试

```javascript
// tests/api.test.js
const request = require('supertest');
const app = require('../app');

describe('Tasks API', () => {
    test('GET /api/tasks', async () => {
        const response = await request(app)
            .get('/api/tasks')
            .expect(200);
        
        expect(response.body).toHaveProperty('tasks');
        expect(Array.isArray(response.body.tasks)).toBe(true);
    });
    
    test('POST /api/tasks', async () => {
        const response = await request(app)
            .post('/api/tasks')
            .send({
                title: 'New Task',
                description: 'New Description'
            })
            .expect(201);
        
        expect(response.body.task).toHaveProperty('id');
        expect(response.body.task.title).toBe('New Task');
    });
});
```

## 运行测试

```bash
# 运行所有测试
npm test

# 运行特定测试文件
npm test -- tests/task.test.js

# 生成覆盖率报告
npm run test:coverage
```

## 部署准备

### 环境变量

创建 `.env` 文件：

```env
NODE_ENV=production
PORT=3000
DB_PATH=./database.sqlite
```

### 构建前端

```bash
cd frontend
npm run build
```

构建后的文件在 `dist/` 目录。

## 部署选项

### 选项 1：Vercel（推荐）

1. **安装 Vercel CLI**
   ```bash
   npm install -g vercel
   ```

2. **部署**
   ```bash
   vercel
   ```

3. **配置环境变量**
   在 Vercel 控制台添加环境变量。

### 选项 2：Docker

**Dockerfile:**
```dockerfile
FROM node:18-alpine

WORKDIR /app

COPY package*.json ./
RUN npm install --production

COPY . .

EXPOSE 3000

CMD ["node", "server.js"]
```

**构建和运行:**
```bash
docker build -t todo-app .
docker run -p 3000:3000 todo-app
```

### 选项 3：传统服务器

1. **上传文件**
   ```bash
   scp -r dist/ user@server:/var/www/todo-app
   ```

2. **安装依赖**
   ```bash
   ssh user@server
   cd /var/www/todo-app
   npm install --production
   ```

3. **使用 PM2 运行**
   ```bash
   npm install -g pm2
   pm2 start server.js
   pm2 save
   ```

## 监控和维护

### 日志管理

```javascript
// 使用 winston 记录日志
const winston = require('winston');

const logger = winston.createLogger({
    level: 'info',
    format: winston.format.json(),
    transports: [
        new winston.transports.File({ filename: 'error.log', level: 'error' }),
        new winston.transports.File({ filename: 'combined.log' })
    ]
});
```

### 健康检查

```javascript
// routes/health.js
router.get('/health', (req, res) => {
    res.json({
        status: 'ok',
        timestamp: new Date().toISOString(),
        uptime: process.uptime()
    });
});
```

## 总结

通过本章学习，我们完成了：

- ✅ 编写测试用例
- ✅ 运行测试
- ✅ 准备部署
- ✅ 选择部署方案
- ✅ 监控和维护

## 恭喜！

你已经完成了整个教程的学习！现在你可以：

1. 继续完善项目功能
2. 添加更多测试用例
3. 优化性能和用户体验
4. 分享你的项目

---

**提示**：这是示例文章，展示了如何编写测试和部署教程。

